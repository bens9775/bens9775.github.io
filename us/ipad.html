<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wall Display</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .datetime {
            text-align: center;
        }

        .time {
            font-size: 3.5em;
            font-weight: 200;
            letter-spacing: 2px;
        }

        .date {
            font-size: 1.2em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .weather {
            text-align: center;
            min-width: 200px;
        }

        .weather-temp {
            font-size: 2.5em;
            font-weight: 300;
        }

        .weather-desc {
            font-size: 1em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .weather-location {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 3px;
        }

        .hourly-forecast {
            margin-top: 20px;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .forecast-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 5px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE */
        }

        .forecast-scroll::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .forecast-hour {
            flex: 0 0 auto;
            text-align: center;
            min-width: 60px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .forecast-hour:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .forecast-time {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .forecast-temp {
            font-size: 1.1em;
            font-weight: 500;
            color: #fff;
            margin-bottom: 5px;
        }

        .forecast-desc {
            font-size: 0.7em;
            opacity: 0.7;
            line-height: 1.2;
        }

        .slideshow-container {
            flex: 1;
            position: relative;
            margin: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .slide {
            display: none;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .slide.active {
            display: block;
        }

        .slide-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: 20px;
            text-align: center;
        }

        .slide-counter {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Responsive adjustments for iPad Mini */
        @media screen and (max-width: 1024px) {
            .header {
                padding: 15px 20px;
            }
            
            .time {
                font-size: 2.8em;
            }
            
            .weather-temp {
                font-size: 2em;
            }
            
            .slideshow-container {
                margin: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="datetime">
            <div class="time" id="time">00:00:00</div>
            <div class="date" id="date">Loading...</div>
        </div>
        
        <div class="weather">
            <div class="weather-temp" id="temp">--¬∞</div>
            <div class="weather-desc" id="weather-desc">Loading weather...</div>
            <div class="weather-location" id="location">Your Location</div>
        </div>
    </div>

    <div class="hourly-forecast">
        <div class="forecast-scroll" id="hourly-forecast">
            <div class="forecast-hour">
                <div class="forecast-time">Loading...</div>
                <div class="forecast-temp">--¬∞</div>
                <div class="forecast-desc">--</div>
            </div>
        </div>
    </div>

    <div class="slideshow-container" id="slideshow-container">
        <!-- Images will be loaded dynamically -->
        <div class="slide active">
            <div class="slide-overlay">
                <div class="slide-counter">Loading images...</div>
            </div>
        </div>
    </div>

    <script>
        // Image loading configuration
        var IMAGE_BASE_URL = 'https://benandkb.com/us/images2/';
        var loadedImages = [];
        var imagesLoaded = false;

        // Function to test if an image exists (iOS 9.3.5 compatible)
        function testImage(url, callback) {
            var img = new Image();
            var timeout;
            
            img.onload = function() {
                if (timeout) clearTimeout(timeout);
                callback(true);
            };
            
            img.onerror = function() {
                if (timeout) clearTimeout(timeout);
                callback(false);
            };
            
            // Add timeout for iOS 9.3.5 compatibility
            timeout = setTimeout(function() {
                callback(false);
            }, 3000);
            
            img.src = url;
        }

        // Function to load images sequentially starting from image1.jpg
        function loadImagesFromDirectory() {
            var foundImages = [];
            var currentImageNum = 1;
            var consecutiveMisses = 0;
            var maxConsecutiveMisses = 5; // Stop after 5 consecutive misses

            function testNextImage() {
                if (consecutiveMisses >= maxConsecutiveMisses) {
                    // Done searching, randomize and finalize results
                    if (foundImages.length > 0) {
                        // Shuffle the images randomly
                        for (var i = foundImages.length - 1; i > 0; i--) {
                            var j = Math.floor(Math.random() * (i + 1));
                            var temp = foundImages[i];
                            foundImages[i] = foundImages[j];
                            foundImages[j] = temp;
                        }
                        
                        loadedImages = foundImages;
                        createImageSlides();
                        imagesLoaded = true;
                        console.log('Found and randomized ' + foundImages.length + ' images');
                    } else {
                        showImageError();
                    }
                    return;
                }

                var url = IMAGE_BASE_URL + 'image' + currentImageNum + '.jpg';
                console.log('Testing image: ' + url); // Debug log for iPad
                
                testImage(url, function(exists) {
                    console.log('Image ' + currentImageNum + ' exists: ' + exists); // Debug log
                    
                    if (exists) {
                        foundImages.push(url);
                        consecutiveMisses = 0; // Reset miss counter
                    } else {
                        consecutiveMisses++;
                    }
                    
                    currentImageNum++;
                    
                    // Continue testing with longer delay for iOS 9.3.5
                    setTimeout(testNextImage, 50);
                });
            }

            // Start the sequential testing
            testNextImage();
        }

        // Create slide elements for found images
        function createImageSlides() {
            var container = document.getElementById('slideshow-container');
            container.innerHTML = '';

            if (loadedImages.length === 0) {
                showImageError();
                return;
            }

            for (var i = 0; i < loadedImages.length; i++) {
                var slideDiv = document.createElement('div');
                slideDiv.className = 'slide' + (i === 0 ? ' active' : '');
                slideDiv.style.backgroundImage = 'url("' + loadedImages[i] + '")';
                
                var overlayDiv = document.createElement('div');
                overlayDiv.className = 'slide-overlay';
                overlayDiv.innerHTML = '<div class="slide-counter">' + (i + 1) + ' / ' + loadedImages.length + '</div>';
                
                slideDiv.appendChild(overlayDiv);
                container.appendChild(slideDiv);
            }

            // Update global variables
            slides = document.getElementsByClassName('slide');
            totalSlides = slides.length;
            currentSlide = 0;
            
            // Show first slide immediately
            if (totalSlides > 0) {
                showSlide(0);
                // Start the slideshow cycling immediately
                setInterval(nextSlide, 10000);
            }
        }

        function showImageError() {
            var container = document.getElementById('slideshow-container');
            container.innerHTML = '<div class="slide active"><div class="slide-overlay"><div class="slide-counter">No images found. Expected: image1.jpg, image2.jpg, etc.</div></div></div>';
        }

        // Variables
        var currentSlide = 0;
        var slides = document.getElementsByClassName('slide');
        var totalSlides = slides.length;

        // Update time and date
        function updateDateTime() {
            var now = new Date();
            
            // Format time manually for 12-hour format
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();
            var ampm = hours >= 12 ? 'PM' : 'AM';
            
            // Convert to 12-hour format
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            
            // Pad with zeros
            var timeString = (hours < 10 ? ' ' : '') + hours + ':' +
                           (minutes < 10 ? '0' : '') + minutes + ':' +
                           (seconds < 10 ? '0' : '') + seconds + ' ' + ampm;
            
            // Format date manually for better compatibility
            var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            var months = ['January', 'February', 'March', 'April', 'May', 'June',
                         'July', 'August', 'September', 'October', 'November', 'December'];
            
            var dayName = days[now.getDay()];
            var monthName = months[now.getMonth()];
            var dayNum = now.getDate();
            
            var dateString = dayName + ', ' + monthName + ' ' + dayNum;
            
            // Update the DOM elements
            var timeElement = document.getElementById('time');
            var dateElement = document.getElementById('date');
            
            if (timeElement) {
                timeElement.textContent = timeString;
            }
            if (dateElement) {
                dateElement.textContent = dateString;
            }
        }

        // Weather API configuration
        var WEATHER_API_KEY = '325a407c3c7b1194f72848d8252a2683';
        var LAT = 38.9517;
        var LON = -92.3341;
        var WEATHER_UNITS = 'imperial';
        
        function updateWeatherOpenWeatherMap() {
            // Current weather using coordinates
            var currentUrl = 'https://api.openweathermap.org/data/2.5/weather?lat=' + 
                      LAT + '&lon=' + LON + 
                      '&appid=' + WEATHER_API_KEY + 
                      '&units=' + WEATHER_UNITS;
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', currentUrl, true);
            xhr.timeout = 10000;
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            var temp = Math.round(data.main.temp) + '¬∞' + 
                                      (WEATHER_UNITS === 'imperial' ? 'F' : 'C');
                            var description = data.weather[0].description;
                            var location = data.name + ', ' + data.sys.country;
                            
                            document.getElementById('temp').textContent = temp;
                            document.getElementById('weather-desc').textContent = 
                                description.charAt(0).toUpperCase() + description.slice(1);
                            document.getElementById('location').textContent = location;
                            
                            // Use the same coordinates for hourly forecast
                            updateHourlyForecast(LAT, LON);
                            
                        } catch (e) {
                            console.error('Weather parsing error:', e);
                            showWeatherError();
                        }
                    } else {
                        console.error('Weather API error:', xhr.status);
                        showWeatherError();
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('Weather network error');
                showWeatherError();
            };
            
            xhr.ontimeout = function() {
                console.error('Weather request timeout');
                showWeatherError();
            };
            
            xhr.send();
        }
        
        function updateHourlyForecast(lat, lon) {
            var forecastUrl = 'https://api.openweathermap.org/data/2.5/forecast?lat=' + 
                             lat + '&lon=' + lon + 
                             '&appid=' + WEATHER_API_KEY + 
                             '&units=' + WEATHER_UNITS;
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', forecastUrl, true);
            xhr.timeout = 10000;
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            displayHourlyForecast(data.list);
                        } catch (e) {
                            console.error('Forecast parsing error:', e);
                            showForecastError();
                        }
                    } else {
                        console.error('Forecast API error:', xhr.status);
                        showForecastError();
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('Forecast network error');
                showForecastError();
            };
            
            xhr.ontimeout = function() {
                console.error('Forecast request timeout');
                showForecastError();
            };
            
            xhr.send();
        }
        
        function displayHourlyForecast(forecastList) {
            var container = document.getElementById('hourly-forecast');
            container.innerHTML = '';
            
            var now = new Date();
            var currentHour = now.getHours();
            
            // Create 12 consecutive hours starting from current hour
            for (var i = 0; i < 12; i++) {
                var targetHour = (currentHour + i) % 24;
                var targetDate = new Date(now);
                targetDate.setHours(targetHour, 0, 0, 0);
                
                // If we've wrapped to next day, add a day
                if (targetHour < currentHour) {
                    targetDate.setDate(targetDate.getDate() + 1);
                }
                
                // Find closest forecast data for this hour
                var closestForecast = findClosestForecast(forecastList, targetDate);
                
                var hourDiv = document.createElement('div');
                hourDiv.className = 'forecast-hour';
                
                // Format time for display
                var displayHour = targetHour % 12;
                displayHour = displayHour ? displayHour : 12; // 0 should be 12
                var ampm = targetHour >= 12 ? 'PM' : 'AM';
                var timeStr = displayHour + ampm;
                
                var temp = '--¬∞';
                var weatherEmoji = '‚ùì';
                
                if (closestForecast) {
                    temp = Math.round(closestForecast.main.temp) + '¬∞';
                    weatherEmoji = getWeatherEmoji(closestForecast.weather[0].main);
                }
                
                hourDiv.innerHTML = 
                    '<div class="forecast-time">' + timeStr + '</div>' +
                    '<div class="forecast-temp">' + temp + '</div>' +
                    '<div class="forecast-desc">' + weatherEmoji + '</div>';
                
                container.appendChild(hourDiv);
            }
        }
        
        function findClosestForecast(forecastList, targetDate) {
            var targetTime = targetDate.getTime();
            var closest = null;
            var closestDiff = Infinity;
            
            for (var i = 0; i < forecastList.length; i++) {
                var forecastTime = forecastList[i].dt * 1000;
                var diff = Math.abs(targetTime - forecastTime);
                
                if (diff < closestDiff) {
                    closestDiff = diff;
                    closest = forecastList[i];
                }
            }
            
            return closest;
        }
        
        function getWeatherEmoji(condition) {
            // Use simple emojis that work on iOS 9.3.5
            switch (condition.toLowerCase()) {
                case 'clear':
                    return '‚òÄÔ∏è';
                case 'clouds':
                    return '‚òÅÔ∏è';
                case 'rain':
                    return 'üåßÔ∏è';
                case 'drizzle':
                    return 'üå¶Ô∏è';
                case 'thunderstorm':
                    return '‚õàÔ∏è';
                case 'snow':
                    return '‚ùÑÔ∏è';
                case 'mist':
                case 'fog':
                    return 'üå´Ô∏è';
                default:
                    return 'üå§Ô∏è';
            }
        }
        
        function showForecastError() {
            var container = document.getElementById('hourly-forecast');
            container.innerHTML = '<div class="forecast-hour"><div class="forecast-desc">Forecast unavailable</div></div>';
        }
        
        function showWeatherError() {
            document.getElementById('temp').textContent = '--¬∞';
            document.getElementById('weather-desc').textContent = 'Weather unavailable';
            document.getElementById('location').textContent = 'Check connection';
            showForecastError();
        }
        
        // Main weather function
        function updateWeather() {
            updateWeatherOpenWeatherMap();
        }
        
        // Slideshow functions
        function showSlide(n) {
            // Hide all slides
            for (var i = 0; i < slides.length; i++) {
                slides[i].classList.remove('active');
            }
            
            // Show current slide
            if (n >= totalSlides) currentSlide = 0;
            if (n < 0) currentSlide = totalSlides - 1;
            
            slides[currentSlide].classList.add('active');
        }

        function nextSlide() {
            currentSlide++;
            showSlide(currentSlide);
        }

        // Fullscreen function for better browser support
        function requestFullscreen() {
            var elem = document.documentElement;
            
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { // Safari
                elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) { // Firefox
                elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) { // IE/Edge
                elem.msRequestFullscreen();
            }
        }

        // Initialize and start intervals
        function init() {
            updateDateTime();
            updateWeather();
            
            // Load images sequentially
            loadImagesFromDirectory();
            
            // Update time every second
            setInterval(updateDateTime, 1000);
            
            // Update weather every 30 minutes
            setInterval(updateWeather, 30 * 60 * 1000);
            
            // Slideshow interval is now started in createImageSlides()
        }

        // Prevent screen from sleeping (iOS specific)
        function preventSleep() {
            // Keep screen active by periodically updating a hidden element
            setInterval(function() {
                var hidden = document.createElement('div');
                hidden.style.position = 'absolute';
                hidden.style.left = '-9999px';
                document.body.appendChild(hidden);
                setTimeout(function() {
                    document.body.removeChild(hidden);
                }, 100);
            }, 60000);
        }

        // Try to go fullscreen on first user interaction
        var hasInteracted = false;
        function handleFirstInteraction() {
            if (!hasInteracted) {
                hasInteracted = true;
                requestFullscreen();
                // Remove the event listeners after first use
                document.removeEventListener('touchstart', handleFirstInteraction);
                document.removeEventListener('click', handleFirstInteraction);
            }
        }

        // Function to hide Safari address bar on iOS 9.3.5
        function hideAddressBar() {
            // Scroll slightly to hide the address bar
            setTimeout(function() {
                window.scrollTo(0, 1);
            }, 100);
            
            // Additional attempts in case the first doesn't work
            setTimeout(function() {
                window.scrollTo(0, 0);
                window.scrollTo(0, 1);
            }, 500);
        }

        // Make body tall enough to enable scrolling briefly
        function enableAddressBarHiding() {
            // Temporarily make the body taller
            document.body.style.minHeight = (window.innerHeight + 100) + 'px';
            
            hideAddressBar();
            
            // Reset height after hiding address bar
            setTimeout(function() {
                document.body.style.minHeight = '100vh';
            }, 1000);
        }

        // Start everything when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                init();
                preventSleep();
                enableAddressBarHiding();
                
                // Add fullscreen listeners for first interaction
                document.addEventListener('touchstart', handleFirstInteraction);
                document.addEventListener('click', handleFirstInteraction);
            });
        } else {
            init();
            preventSleep();
            enableAddressBarHiding();
            
            // Add fullscreen listeners for first interaction
            document.addEventListener('touchstart', handleFirstInteraction);
            document.addEventListener('click', handleFirstInteraction);
        }

        // Touch events to manually control slideshow (optional)
        var startX = 0;
        document.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
        });

        document.addEventListener('touchend', function(e) {
            var endX = e.changedTouches[0].clientX;
            var diff = startX - endX;
            
            if (Math.abs(diff) > 50) { // Minimum swipe distance
                if (diff > 0) {
                    // Swipe left - next slide
                    nextSlide();
                } else {
                    // Swipe right - previous slide
                    currentSlide--;
                    showSlide(currentSlide);
                }
            }
        });
    </script>
</body>
</html>